# Техническое Задание: Стратегия "Pure Market Making"

## 1. Общее Описание

**Название стратегии:** Pure Market Making (PMM)
**Цель:** Получение прибыли за счет постоянного удержания лимитных ордеров на покупку (bid) и продажу (ask) на одном рынке, зарабатывая на разнице цен (спреде) между ними. Стратегия является "мейкером" ликвидности.

## 2. Основные Сущности

- **Рынок (Market):** Объект, предоставляющий доступ к бирже. Должен иметь методы для:
    - Получения стакана ордеров (Order Book).
    - Получения текущих балансов активов.
    - Размещения лимитных ордеров (`buy`, `sell`).
    - Отмены ордеров (`cancel`).
    - Получения информации о комиссиях (`get_fee`).
    - Квантования цен и объемов (приведения к минимально возможному шагу на бирже).
- **Ордер (Order):** Структура данных, описывающая лимитный ордер (ID, торговая пара, сторона, цена, объем, статус).
- **Предложение (Proposal):** Внутренний объект, содержащий список планируемых ордеров на покупку и продажу (`List[PriceSize]`) перед их размещением.

## 3. Конфигурационные Параметры

Стратегия должна быть настраиваемой через следующие параметры:

| Параметр | Тип | Описание | Пример |
|---|---|---|---|
| `exchange` | string | Идентификатор биржи. | `mexc` |
| `market` | string | Торговая пара. | `BTC-USDT` |
| `bid_spread` | Decimal | Процентное отклонение вниз от центральной цены для ордера на покупку. | `0.15` (0.15%) |
| `ask_spread` | Decimal | Процентное отклонение вверх от центральной цены для ордера на продажу. | `0.15` (0.15%) |
| `order_amount` | Decimal | Объем каждого ордера в базовом активе. | `0.01` (для BTC-USDT) |
| `order_refresh_time` | float | Периодичность (в секундах), с которой стратегия переоценивает и переставляет ордера. | `10.0` |
| `order_refresh_tolerance_pct` | Decimal | Порог изменения цены (в %), при превышении которого ордера не отменяются. Если `0`, ордера отменяются при любом изменении. Если `-1`, ордера никогда не отменяются по этому условию. | `0.2` (0.2%) |
| `filled_order_delay` | float | Задержка (в секундах) перед созданием новых ордеров после исполнения одного из текущих. | `60.0` |
| `ping_pong_enabled` | boolean | Если `true`, после исполнения ордера на покупку будет выставляться только ордер на продажу, и наоборот. | `true` |
| `price_type` | string | Тип цены, используемый как "центральная цена". Варианты: `mid_price`, `last_price`, `best_bid`, `best_ask`. | `mid_price` |
| `inventory_skew_enabled` | boolean | Включает/выключает механизм асимметричного изменения объемов для балансировки инвентаря. | `false` |
| `inventory_target_base_pct` | Decimal | Целевой процент базового актива в портфеле (от 0 до 100). Используется, если `inventory_skew_enabled` = `true`. | `50.0` |
| `inventory_range_multiplier` | Decimal | Коэффициент чувствительности перекоса. Определяет, насколько агрессивно стратегия будет возвращаться к целевому балансу. | `1.0` |

| `order_levels` | int | Количество ордеров, выставляемых с каждой стороны (bid/ask). | `1` |
| `order_level_spread` | Decimal | Дополнительный спред для каждого следующего уровня ордеров. | `0.1` (0.1%) |
| `hanging_orders_enabled` | boolean | Если `true`, частично исполненные ордера не отменяются при обновлении, а остаются в стакане. | `false` |
| `price_ceiling` / `price_floor` | Decimal | Ценовые "потолок" и "пол", за пределами которых бот не будет выставлять ордера на покупку/продажу соответственно. `-1` для отключения. | `-1` |
| `order_optimization_enabled` | boolean | Если `true`, бот будет пытаться ставить свои ордера на один шаг лучше, чем текущие лучшие bid/ask в стакане. | `false` |

## 4. Алгоритм Работы (Цикл `tick`)

Основной цикл должен выполняться с заданной периодичностью (например, 1 раз в секунду).

**Шаг 1: Проверки и подготовка**
1.1. Проверить, готово ли подключение к бирже. Если нет, прервать цикл.
1.2. Проверить, не активна ли задержка после исполнения ордера (`filled_order_delay`). Если активна, прервать цикл.

**Шаг 2: Создание базового "Предложения" (Proposal)**
2.1. **Определить центральную цену:** Получить цену с рынка в соответствии с параметром `price_type`.
2.2. **Рассчитать цены ордеров:**
    - `buy_price = central_price * (1 - bid_spread / 100)`
    - `sell_price = central_price * (1 + ask_spread / 100)`
2.3. **Сформировать `Proposal`:** Создать объект, содержащий список планируемых ордеров. Если `order_levels` > 1, то для каждого уровня `i` от 0 до `order_levels - 1`:
    - `buy_price_i = central_price * (1 - bid_spread / 100 - i * order_level_spread / 100)`
    - `sell_price_i = central_price * (1 + ask_spread / 100 + i * order_level_spread / 100)`
    - Добавить ордера с этими ценами и объемом `order_amount` в `Proposal`.

**Шаг 3: Модификация "Предложения"**
3.1. **Применить ценовой коридор:**
    - Если `price_ceiling` установлен и `central_price >= price_ceiling`, удалить все ордера на покупку из `Proposal`.
    - Если `price_floor` установлен и `central_price <= price_floor`, удалить все ордера на продажу из `Proposal`.
3.2. **Применить `ping_pong`:** Если `ping_pong_enabled` = `true`:
    - Если последней была исполнена покупка, удалить из `Proposal` все ордера на покупку.
    - Если последней была исполнена продажа, удалить из `Proposal` все ордера на продажу.
3.3. **Применить `inventory_skew` (Смарт-управление инвентарем):** Если `inventory_skew_enabled` = `true`:
    - **3.3.1. Расчет общей стоимости портфеля:**
        - `total_portfolio_value_in_quote = (base_asset_balance * mid_price) + quote_asset_balance`
    - **3.3.2. Расчет текущего процента базового актива:**
        - `current_base_asset_pct = (base_asset_balance * mid_price) / total_portfolio_value_in_quote * 100`
    - **3.3.3. Расчет отклонения от цели:**
        - `inventory_delta = current_base_asset_pct - inventory_target_base_pct`
    - **3.3.4. Расчет "зоны комфорта" (inventory range):**
        - `inventory_range = (order_amount * 2) * inventory_range_multiplier`
        - Эта зона определяет, насколько агрессивно будет работать перекос.
    - **3.3.5. Расчет коэффициентов перекоса (`bid_ratio`, `ask_ratio`):**
        - Логика должна быть реализована так, чтобы при положительном `inventory_delta` (избыток базового актива) `ask_ratio` увеличивался, а `bid_ratio` уменьшался. При отрицательном `inventory_delta` (дефицит) — наоборот.
        - Коэффициенты должны изменяться от 0 до 2. Если отклонение инвентаря выходит за пределы "зоны комфорта", один из коэффициентов должен стремиться к 0 (полностью отключая одну сторону), а другой — к 2 (удваивая объем).
        - **Примерная формула:** `ask_ratio = 1 + (inventory_delta / (inventory_range / 2))`, `bid_ratio = 1 - (inventory_delta / (inventory_range / 2))`. (Необходимо ограничить значения в диапазоне [0, 2]).
    - **3.3.6. Изменение объемов в `Proposal`:**
        - `buy_order.amount *= bid_ratio`
        - `sell_order.amount *= ask_ratio`
3.4. **Применить оптимизацию ордеров:** Если `order_optimization_enabled` = `true`:
    - Получить лучшую цену покупки (`top_bid`) и продажи (`top_ask`) из стакана ордеров.
    - Для ордеров на покупку в `Proposal`: если их цена выше `top_bid`, скорректировать ее до `top_bid + min_price_step`.
    - Для ордеров на продажу в `Proposal`: если их цена ниже `top_ask`, скорректировать ее до `top_ask - min_price_step`.
3.5. **Применить бюджетные ограничения:**
    - Проверить доступный баланс квотируемого актива для всех ордеров на покупку. Если баланса не хватает, уменьшить объемы ордеров (начиная с самых дальних) до максимально возможных.
    - Проверить доступный баланс базового актива для всех ордеров на продажу. Если баланса не хватает, уменьшить объемы.

**Шаг 4: Управление активными ордерами**
4.1. Получить список активных лимитных ордеров стратегии с биржи.
4.2. **Логика отмены:**
    - **Исключение для "подвисших" ордеров:** Если `hanging_orders_enabled` = `true`, ордера, которые были исполнены частично, не подлежат отмене в этом цикле.
    - Если цены в `Proposal` значительно отличаются от цен активных ордеров (разница > `order_refresh_tolerance_pct`), отменить все активные (не "подвисшие") ордера.
    - Если с момента последнего обновления ордеров прошло больше времени, чем `order_refresh_time`, отменить все активные (не "подвисшие") ордера.
    - Если возраст любого активного ордера превышает `max_order_age`, отменить этот ордер.
4.3. Если активных ордеров (не "подвисших") нет или они были только что отменены, перейти к Шагу 5.

**Шаг 5: Размещение новых ордеров**
5.1. Взять ордера из финального объекта `Proposal`.
5.2. Если объем ордера на покупку > 0, отправить на биржу лимитный ордер на покупку.
5.3. Если объем ордера на продажу > 0, отправить на биржу лимитный ордер на продажу.
5.4. Сохранить ID созданных ордеров для отслеживания.

## 5. Обработка Событий

Стратегия должна асинхронно обрабатывать события от биржи:

- **`OrderFilledEvent` (Ордер исполнен частично или полностью):**
    - Записать информацию о сделке (цена, объем, комиссия).
    - Если `ping_pong_enabled` = `true`, обновить внутреннее состояние (какая сторона была исполнена).
    - Активировать таймер `filled_order_delay`.
    - Если `hanging_orders_enabled` = `true` и ордер исполнен частично, пометить его как "подвисший" (hanging), чтобы он не отменялся при следующем обновлении.
- **`OrderCompletedEvent` (Ордер полностью исполнен):**
    - Удалить ордер из списка активных.
- **`OrderCancelledEvent` (Ордер отменен):**
    - Удалить ордер из списка активных.
- **`OrderExpiredEvent` (Срок действия ордера истек):**
    - Удалить ордер из списка активных.

## 6. Управление Состоянием

Стратегия должна хранить и управлять следующими внутренними переменными состояния:
- `_active_order_ids`: Список ID активных ордеров.
- `_last_filled_side`: Какая сторона (buy/sell) была исполнена последней (для `ping_pong`).
- `_next_refresh_timestamp`: Время следующего принудительного обновления ордеров.
- `_filled_order_delay_timestamp`: Время, до которого действует задержка после исполнения.

## 7. Зависимости

Для реализации данной стратегии необходимы следующие компоненты от базового фреймворка:
- **Коннектор к бирже:** Предоставляет API для работы с рынком.
- **Трекер ордеров:** Отслеживает статусы и события по активным ордерам.
- **Менеджер балансов:** Предоставляет актуальную информацию о доступных средствах.
- **Циклический таймер (`tick`):** Обеспечивает периодический вызов основного алгоритма стратегии.