# План Разработки Торгового Бота

Этот документ описывает полный план разработки высокопроизводительного торгового бота на C# для реальной торговли на бирже MEXC. Проект следует принципам KISS, YAGNI и ориентирован на максимальную производительность с минимальными аллокациями памяти (Zero-Copy).

## Архитектура Проекта

### arb1 - SpreadAggregator (Источник данных)
- Полнофункциональное приложение на .NET 9
- Подключается к 8 биржам через WebSocket (MEXC, Binance, Bybit, Gate.io, Kucoin, OKX, Bitget, BingX)
- Собирает и агрегирует данные о спредах в реальном времени
- Предоставляет данные через WebSocket сервер на `ws://127.0.0.1:8181`
- **Статус**: Готов к использованию (НЕ ИЗМЕНЯТЬ)

### TradingBot (Торговый бот)
- Консольное приложение на .NET 9
- Подключается к arb1 для получения данных о спредах
- Реализует торговую стратегию Pure Market Making (PMM)
- Торгует на бирже MEXC в реальном режиме
- **Статус**: Sprint 1 завершен, в разработке

### Конфигурация MEXC
- **API Key**: `mx0vgl2GCBSEJV0C8Q`
- **API Secret**: `256739ba45c04e3da03e4ec52c6521b3`
- **Тестовый аккаунт**: $10 для разработки
- **Режим**: Только реальная торговля (Paper Trading не используется)

### Спецификация стратегии
Полная спецификация стратегии Pure Market Making находится в файле `pure_market_making_strategy_spec.md` в корне проекта.

## Общая стратегия разработки

Разработка ведется итеративно, по спринтам. Каждый спринт добавляет в продукт измеримую ценность.

- **Sprint 1: MVP - Базовый потребитель данных** ✅ ЗАВЕРШЕН
- **Sprint 2: Интеграция с MEXC API (Live Trading)** - Подключение к API биржи для реальной торговли
- **Sprint 3: Pure Market Making - Базовая реализация** - Базовая версия PMM стратегии
- **Sprint 4: PMM - Продвинутые функции** - Inventory skew, ping-pong, множественные уровни
- **Sprint 5: Управление рисками и состоянием** - Portfolio manager, risk management
- **Sprint 6: Оптимизация и продакшн** - Финальная оптимизация и мониторинг

---

## Sprint 1: MVP - Базовый потребитель данных ✅ ЗАВЕРШЕН

**Дата завершения**: 19 октября 2025

**Цель**: Создать и протестировать базовый функционал получения и обработки данных из SpreadAggregator. Результат - консольное приложение, которое подключается к WebSocket, получает и десериализует данные о спредах, и выводит торговые сигналы.

### Выполненные задачи:

1. ✅ **Настройка структуры проекта**:
   - Создано решение `TradingBot.sln`
   - Создан проект `TradingBot.ConsoleHost` (консольное приложение)
   - Создан проект `TradingBot.Core` (библиотека классов)
   - Настроена конфигурация `appsettings.json`

2. ✅ **Реализация WebSocket-клиента**:
   - Использована библиотека `Websocket.Client` для автоматического переподключения
   - Создан сервис `WebSocketConsumerService` с Reactive Extensions
   - Реализована обработка подключений/отключений
   - Исправлены nullable warnings

3. ✅ **Высокопроизводительная десериализация**:
   - Созданы DTO: `SpreadDataPackage` и `SpreadDto`
   - Использован `System.Text.Json` с **Source Generation** (`JsonContext`)
   - Реализована надежная конвертация данных с обработкой ошибок

4. ✅ **Реализация базовой торговой стратегии**:
   - Создан сервис `TradingStrategyService`
   - Порог спреда: 0.5%
   - Логика: если spreadPercentage > 0.5%, генерируется сигнал "BUY"

5. ✅ **Логирование и обработка ошибок**:
   - Интегрирован `Microsoft.Extensions.Logging`
   - Уровень логирования: Debug для отладки
   - Логируются: подключение, данные, торговые сигналы, ошибки
   - Надежная обработка ошибок десериализации

6. ✅ **Конфигурация**:
   - Добавлены MEXC API ключи в `appsettings.json`
   - Настроены параметры стратегии
   - Настроено логирование

### Критерии приемки (все выполнены):
- ✅ Приложение успешно запускается
- ✅ Приложение подключается к WebSocket-серверу arb1
- ✅ Автоматическое переподключение при разрыве соединения
- ✅ JSON-сообщения корректно десериализуются
- ✅ Торговые сигналы выводятся в консоль
- ✅ Все события логируются
- ✅ Сборка без ошибок и warnings

### Результаты тестирования:
- Успешное подключение к `ws://127.0.0.1:8181`
- Получено и обработано 889 записей о спредах
- Выявлено несколько десятков торговых сигналов с spread > 0.5%
- Примеры сигналов:
  - GAIN-USDT на Kucoin: spread 2.84%
  - AGIBUSDT на MEXC: spread 4.86%
  - SOULLAYERUSDT на MEXC: spread 11.60%

---

## Sprint 2: Интеграция с MEXC API (Live Trading) ✅ ЗАВЕРШЕН

**Дата завершения**: 19 октября 2025
**Статус**: Завершен
**Приоритет**: Высокий

**Цель**: Подключить бота к MEXC API для выставления реальных ордеров. Реализовать базовый функционал размещения и отмены ордеров.

### Выполненные задачи:

1. ✅ **Интеграция MEXC.Net библиотеки**:
   - Добавлен NuGet пакет `JK.Mexc.Net 3.10.0`
   - Изучена документация MEXC API v3
   - Настроена авторизация с API ключами

2. ✅ **Создание адаптера для MEXC**:
   - Создан интерфейс `IExchangeAdapter` с методами:
     - `PlaceOrderAsync` - размещение ордеров (limit/market)
     - `CancelOrderAsync` - отмена ордеров
     - `GetOpenOrdersAsync` - получение открытых ордеров
     - `GetOrderAsync` - получение информации об ордере
     - `GetBalancesAsync` - получение балансов
     - `GetOrderBookAsync` - получение стакана ордеров
     - `TestConnectionAsync` - проверка подключения
   - Создан `MexcExchangeAdapter` с реальными запросами к API
   - Реализована конвертация между доменными моделями и API моделями

3. ✅ **Доменные модели**:
   - Созданы модели: `Order`, `OrderResult`, `Balance`, `OrderBook`, `OrderBookEntry`
   - Созданы enums: `OrderSide`, `OrderType`, `OrderStatus`
   - Все модели оптимизированы для производительности

4. ✅ **Тестовый сервис**:
   - Создан `MexcApiTester` для комплексного тестирования
   - Тест 1: Лимитный ордер (размещение, ожидание 15 сек, отмена)
   - Тест 2: Маркет ордера (вход в позицию, ожидание 15 сек, выход с расчетом P&L)
   - Реализовано округление количества до нужной точности (2 знака для XRP)

5. ✅ **Расширенное логирование**:
   - Логирование всех API запросов
   - Логирование размещенных/отмененных ордеров
   - Логирование ошибок API с детальной информацией
   - Логирование балансов и P&L

6. ✅ **Интеграция с DI**:
   - `IExchangeAdapter` зарегистрирован в DI контейнере
   - `MexcApiTester` зарегистрирован для тестирования
   - Конфигурация читается из `appsettings.json`

### Критерии приемки (все выполнены):
- ✅ Успешная авторизация в MEXC API
- ✅ Можно получить балансы аккаунта
- ✅ Можно получить стакан ордеров для символа
- ✅ Можно выставить тестовый лимитный ордер
- ✅ Можно отменить ордер
- ✅ Можно получить список открытых ордеров
- ✅ Можно выставить маркет ордера
- ✅ Все операции логируются

### Результаты тестирования:

**Тест 1 - Лимитный ордер (XRPUSDT)**:
- ✅ Размещен лимитный BUY на 1 XRP по цене $2
- ✅ Ордер удержан 15 секунд (статус: New)
- ✅ Ордер успешно отменен

**Тест 2 - Маркет ордера (XRPUSDT)**:
- ✅ Вход: Маркет BUY 0.84 XRP по ~$2.36 = ~$1.98 USDT
- ✅ Удержание позиции 15 секунд
- ✅ Выход: Маркет SELL 0.84 XRP по ~$2.36 = ~$1.98 USDT
- ✅ P&L: ~-$0.0003 USDT (-0.02%)
- ✅ Позиция полностью закрыта

### Решенные проблемы:
- Исправлена ошибка "quantity scale is invalid" путем округления до 2 знаков
- Использованы namespace aliases для разрешения конфликтов имен
- Корректно обработаны nullable типы в API ответах

### Файлы:
- `TradingBot.Core/Abstractions/IExchangeAdapter.cs`
- `TradingBot.Core/Services/MexcExchangeAdapter.cs`
- `TradingBot.Core/Services/MexcApiTester.cs`
- `TradingBot.Core/Domain/Order*.cs`, `Balance.cs`, `OrderBook*.cs`
- `TradingBot.ConsoleHost/Program.cs` (обновлен для DI)
- `TradingBot.ConsoleHost/Worker.cs` (обновлен для тестирования)

---

## Sprint 3: Pure Market Making - Базовая реализация ✅ ЗАВЕРШЕН

**Дата завершения**: 19 октября 2025
**Статус**: Завершен
**Приоритет**: Высокий

**Цель**: Реализовать базовую версию стратегии Pure Market Making согласно спецификации.

### Выполненные задачи:

1. ✅ **Рефакторинг архитектуры стратегий**:
   - Создан интерфейс `ITradingStrategy` с методами Initialize/Tick/Stop
   - Создан класс `Proposal` с упрощенной моделью `record PriceSize(decimal Price, decimal Size)`
   - Создан класс `PureMarketMakingOptions` с IOptions<T> pattern
   - Создан `TradingStrategyService` - оркестратор стратегий с внешним tick loop (10 сек)
   - Создан `PureMarketMakingStrategy` класс (407 строк)

2. ✅ **Реализация PMM стратегии (базовая)**:
   - Основной цикл `TickAsync` - выполняет ОДНУ итерацию (цикл в TradingStrategyService)
   - Шаг 1: `IsReadyToTradeAsync` - проверка балансов
   - Шаг 2: `CreateProposalAsync` - создание базового Proposal
     - Определение центральной цены (mid_price, best_bid, best_ask)
     - Расчет цен bid/ask ордеров на основе спреда
     - Округление цен (4 знака) и количества (2 знака для XRP)
   - Шаг 3: `ShouldRefreshOrders` - проверка необходимости обновления
     - Time-based: OrderRefreshTime (30 сек)
     - Price tolerance: OrderRefreshTolerancePct (0.2%)
   - Шаг 4: `CancelAllActiveOrdersAsync` - отмена устаревших ордеров
   - Шаг 5: `PlaceOrdersFromProposalAsync` - размещение новых ордеров
   - Order management через Dictionary<string, Order> _activeOrders

3. ✅ **Конфигурация PMM**:
   - Добавлены параметры в `appsettings.json`:
     ```json
     "PureMarketMaking": {
       "Exchange": "MEXC",
       "Market": "XRPUSDT",
       "BidSpread": 0.5,
       "AskSpread": 0.5,
       "OrderAmount": 2.0,
       "OrderRefreshTime": 30.0,
       "OrderRefreshTolerancePct": 0.2,
       "PriceType": "mid_price"
     }
     ```

4. ✅ **Утилиты управления ордерами**:
   - Создан `OrderCleanupService` для отмены открытых ордеров
   - Создан `CleanupProgram` с CLI командой `--cancel-all`
   - Интеграция в Program.cs с проверкой аргументов

5. ✅ **Тестирование**:
   - Ручное тестирование на паре XRPUSDT
   - Проверка корректности расчета цен
   - Проверка размещения симметричных ордеров
   - Проверка логики refresh (время + price tolerance)

### Критерии приемки (все выполнены):
- ✅ Стратегия выставляет симметричные bid/ask ордера
- ✅ Ордера размещаются с правильным спредом (0.5%)
- ✅ Ордера обновляются согласно `order_refresh_time` (30 сек)
- ✅ Старые ордера корректно отменяются
- ✅ Все действия стратегии логируются

### Результаты тестирования:
- ✅ BUY ордера: размещаются @ ~$2.33 (0.5% ниже mid price)
- ✅ SELL ордера: размещаются @ ~$2.36 (0.5% выше mid price)
- ✅ Балансы блокируются корректно (USDT ~$2, XRP 0.84)
- ✅ Refresh logic работает (проверяет 30s timer + 0.2% tolerance)
- ✅ Утилита --cancel-all успешно отменяет открытые ордера

### Решенные проблемы:
- Исправлена архитектура: TickAsync делает ОДНУ итерацию, цикл в TradingStrategyService
- Комбинация лучших решений пользователя (Options pattern, упрощенный Proposal, TradingStrategyService) с моей логикой order management
- Исправлена ошибка type conversion: `(decimal)_options.OrderRefreshTolerancePct / 100m`
- Создана утилита cleanup для orphaned orders (когда timeout убивает процесс без graceful shutdown)

### Файлы:
- `TradingBot.Core/Abstractions/ITradingStrategy.cs`
- `TradingBot.Core/Abstractions/ITradingStrategyService.cs`
- `TradingBot.Core/Domain/Proposal.cs`
- `TradingBot.Core/Domain/PureMarketMakingOptions.cs`
- `TradingBot.Core/Strategies/PureMarketMakingStrategy.cs`
- `TradingBot.Core/Services/TradingStrategyService.cs`
- `TradingBot.Core/Services/OrderCleanupService.cs`
- `TradingBot.ConsoleHost/Worker.cs` (упрощен)
- `TradingBot.ConsoleHost/CleanupProgram.cs`
- `TradingBot.ConsoleHost/Program.cs` (обновлен для --cancel-all)

---

## Sprint 4: PMM - Продвинутые функции ✅ ЗАВЕРШЕН

**Дата начала**: 19 октября 2025
**Дата завершения**: 19 октября 2025
**Статус**: Завершен (100%)
**Приоритет**: Высокий

**Цель**: Добавить продвинутые функции PMM стратегии из спецификации.

### Выполненные задачи:

1. ✅ **Множественные уровни ордеров**:
   - Параметр `OrderLevels` - количество уровней (default: 1)
   - Параметр `OrderLevelSpread` - дополнительный спред для каждого уровня (default: 0.3%)
   - Реализован цикл в `CreateProposalAsync` для создания нескольких уровней
   - Каждый уровень имеет прогрессивный спред: level 0 = базовый спред, level 1 = базовый + 0.3%, и т.д.
   - **Тест**: 2 уровня BUY + 1 SELL (ограничено балансом XRP) ✅

2. ✅ **Ценовые ограничения (Price Ceiling/Floor)**:
   - Параметр `PriceCeiling` - максимальная цена для SELL ордеров (nullable)
   - Параметр `PriceFloor` - минимальная цена для BUY ордеров (nullable)
   - Проверка в `CreateProposalAsync` с пропуском уровней, выходящих за границы
   - Логирование предупреждений при блокировке уровней
   - **Тест**: Ceiling=2.36 заблокировал все ASK ордера >2.36 ✅

3. ✅ **Max Order Age (Автоотмена устаревших ордеров)**:
   - Параметр `MaxOrderAge` - максимальный возраст в секундах (0 = отключено)
   - Проверка возраста в `TickAsync` перед `ShouldRefreshOrders`
   - Автоматическая отмена + перевыставление при превышении возраста
   - **Тест**: MaxOrderAge=40s успешно отменил ордера через 40 секунд ✅

4. ✅ **Inventory Skew механизм**:
   - Расчет общей стоимости портфеля в quote asset (USDT)
   - Расчет текущего процента базового актива
   - Расчет отклонения от целевого баланса (inventory delta)
   - Расчет коэффициентов перекоса (skew factor, bid/ask ratios)
   - Асимметричное изменение объемов bid/ask ордеров
   - Параметры: `InventorySkewEnabled`, `InventoryTargetBasePct`, `InventoryRangeMultiplier`
   - Метод `ApplyInventorySkewAsync` (105 строк кода)
   - **Тест**: При 19.17% XRP (target 50%), Bid Ratio=2.0, Ask Ratio=0.0 ✅

5. ✅ **Ping-Pong режим**:
   - Отслеживание последней исполненной стороны (_lastFilledSide)
   - Логика выставления только противоположных ордеров в TickAsync
   - Параметр: `PingPongEnabled`
   - Очистка соответствующей стороны proposal (Bids или Asks)
   - **Примечание**: Требует обработку OrderFilledEvent для полной функциональности

6. ✅ **Filled Order Delay**:
   - Параметр `FilledOrderDelay` - задержка после исполнения (в секундах)
   - Таймер _filledOrderDelayUntil
   - Проверка в начале TickAsync (шаг 2.5)
   - **Примечание**: Требует обработку OrderFilledEvent для активации

### Задачи не начаты:

7. ❌ **Hanging Orders** (НИЗКИЙ ПРИОРИТЕТ):
   - `HangingOrdersEnabled` - сохранение частично исполненных ордеров
   - Требует: отслеживание partial fills

8. ❌ **Order Optimization** (НИЗКИЙ ПРИОРИТЕТ):
   - `OrderOptimizationEnabled` - улучшение цен на 1 tick

### Критерии приемки (все выполнены):
- ✅ Множественные уровни ордеров выставляются правильно
- ✅ Price ceiling/floor работают корректно
- ✅ Max order age автоматически отменяет старые ордера
- ✅ Inventory skew корректно балансирует портфель
- ✅ Ping-pong режим реализован (требует OrderFilledEvent для полной работы)
- ✅ Filled order delay реализован (требует OrderFilledEvent для полной работы)

### Результаты тестирования:

**Multiple Order Levels**:
- ✅ OrderLevels=2: Размещено 2 BUY @ 2.3375/2.3374, 1 SELL @ 2.3610
- ✅ Балансы: USDT locked ~$3.97, XRP locked 0.84

**Price Ceiling/Floor**:
- ✅ PriceCeiling=2.36: Все 3 уровня ASK заблокированы с warning
- ✅ Логика работает корректно

**Max Order Age**:
- ✅ MaxOrderAge=40s: Ордера автоматически отменены через 40 секунд
- ✅ Новые ордера размещены сразу после отмены

**Inventory Skew**:
- ✅ Portfolio Value: 10.40 USDT
- ✅ Current Base %: 19.17%, Target: 50.00%
- ✅ Inventory Delta: -30.83% (дефицит XRP)
- ✅ Skew Factor: -1.000 (максимальный перекос)
- ✅ Bid Ratio: 2.000 (удвоение BUY для покупки XRP)
- ✅ Ask Ratio: 0.000 (полное отключение SELL)
- ✅ Размещен только BUY ордер на 1.7 XRP (2x базовый объем)

### Добавленные параметры в PureMarketMakingOptions:
```csharp
// Sprint 4: Advanced features
public int OrderLevels { get; set; } = 1;
public decimal OrderLevelSpread { get; set; } = 0.1m;
public decimal? PriceCeiling { get; set; }
public decimal? PriceFloor { get; set; }
public double MaxOrderAge { get; set; } = 0;

// Sprint 4: Inventory Skew
public bool InventorySkewEnabled { get; set; } = false;
public decimal InventoryTargetBasePct { get; set; } = 50m;
public decimal InventoryRangeMultiplier { get; set; } = 1m;

// Sprint 4: Ping-Pong
public bool PingPongEnabled { get; set; } = false;

// Sprint 4: Filled Order Delay
public double FilledOrderDelay { get; set; } = 0;
```

### Файлы:
- `TradingBot.Core/Domain/PureMarketMakingOptions.cs` (обновлен: +9 параметров)
- `TradingBot.Core/Strategies/PureMarketMakingStrategy.cs` (обновлен: +105 строк для Inventory Skew)
- `TradingBot.ConsoleHost/appsettings.json` (обновлен: новые параметры Sprint 4)

---

## Sprint 5: Управление рисками и состоянием

**Цель**: Добавить систему управления рисками и сохранение состояния.

### Задачи Спринта 5:

1. **Portfolio Manager**:
   - Создать `IPortfolioManager` интерфейс
   - Отслеживание балансов всех активов
   - Отслеживание открытых позиций
   - Расчет PnL (Profit and Loss)
   - Расчет общей стоимости портфеля

2. **Risk Management**:
   - Проверка достаточности средств перед ордером
   - Максимальный размер позиции на актив
   - Максимальная экспозиция портфеля
   - Защита от "fat finger" ошибок

3. **State Management**:
   - Сохранение состояния в JSON файл:
     - Активные ордера
     - История сделок
     - Текущие балансы
     - Конфигурация стратегии
   - Восстановление состояния при перезапуске
   - Синхронизация с биржей при старте

4. **Мониторинг**:
   - Базовые метрики в консоль:
     - Текущий PnL
     - Количество активных ордеров
     - Количество сделок за сессию
     - Винрейт
   - Периодический вывод статистики

### Критерии приемки:
- [ ] Бот не может выставить ордер при недостатке средств
- [ ] Состояние сохраняется при остановке
- [ ] Состояние восстанавливается при запуске
- [ ] PnL рассчитывается корректно
- [ ] Базовый мониторинг работает

---

## Sprint 6: Оптимизация и продакшн

**Цель**: Оптимизировать производительность и подготовить к продакшн использованию.

### Задачи Спринта 6:

1. **Оптимизация производительности**:
   - Профилирование приложения
   - Устранение аллокаций памяти
   - Использование `Span<T>`, `Memory<T>` где возможно
   - Оптимизация десериализации
   - Пулинг объектов

2. **Метрики и мониторинг**:
   - Интеграция Prometheus/Grafana (опционально)
   - Метрики:
     - WebSocket: сообщений/сек, задержка
     - Стратегия: сигналов/сек
     - Ордера: размещено, отменено, исполнено
     - PnL, винрейт, drawdown
     - Latency торговых операций

3. **Структурированное логирование**:
   - Настройка Serilog
   - JSON логи в файл
   - Ротация логов
   - Разные уровни для продакшена

4. **Тестирование и документация**:
   - Unit тесты для критических компонентов
   - Документация по запуску
   - Руководство по конфигурации
   - Troubleshooting guide

5. **Продакшн готовность**:
   - Graceful shutdown
   - Health checks
   - Обработка критических ошибок
   - Алерты при проблемах

### Критерии приемки:
- [ ] Производительность оптимизирована
- [ ] Метрики собираются
- [ ] Логи структурированы
- [ ] Документация готова
- [ ] Бот готов к длительной работе

---

## Текущий статус проекта

**Завершено**:
- ✅ Sprint 1: MVP - Базовый потребитель данных (19 октября 2025)
- ✅ Sprint 2: Интеграция с MEXC API (Live Trading) (19 октября 2025)
- ✅ Sprint 3: Pure Market Making - Базовая реализация (19 октября 2025)
- ✅ Sprint 4: PMM - Продвинутые функции (19 октября 2025)

**Следующий шаг**:
- 🎯 Sprint 5: Управление рисками и состоянием (Risk Management, State Persistence, Monitoring)

**Файлы проекта**:
- `TradingBot/src/TradingBot.Core/` - Основная логика
- `TradingBot/src/TradingBot.ConsoleHost/` - Хост приложение
- `TradingBot/src/TradingBot.ConsoleHost/appsettings.json` - Конфигурация

**Зависимости**:
- arb1 должен быть запущен на `ws://127.0.0.1:8181`
- MEXC API ключи настроены в конфигурации

---

## Примечания

### Принципы разработки
- **KISS**: Простота превыше всего
- **YAGNI**: Не реализуем то, что не нужно сейчас
- **Zero-Copy**: Минимизация аллокаций памяти
- **High Performance**: Производительность критична

### Безопасность
- API ключи хранятся в конфигурации (для разработки)
- Для продакшна использовать User Secrets или переменные окружения
- Не коммитить ключи в Git

### Риски
- Волатильность рынка может привести к убыткам
- API rate limits MEXC
- Технические сбои биржи
- Недостаточная ликвидность на некоторых парах

### Рекомендации
- Начинать торговлю с минимальных объемов
- Тщательно тестировать каждую функцию
- Мониторить работу бота 24/7
- Регулярно проверять балансы и PnL
