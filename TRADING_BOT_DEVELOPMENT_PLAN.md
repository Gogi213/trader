# План Разработки Торгового Бота

Этот документ описывает полный план разработки высокопроизводительного торгового бота на C# для реальной торговли на бирже MEXC. Проект следует принципам KISS, YAGNI и ориентирован на максимальную производительность с минимальными аллокациями памяти (Zero-Copy).

## Архитектура Проекта

### arb1 - SpreadAggregator (Источник данных)
- Полнофункциональное приложение на .NET 9
- Подключается к 8 биржам через WebSocket (MEXC, Binance, Bybit, Gate.io, Kucoin, OKX, Bitget, BingX)
- Собирает и агрегирует данные о спредах в реальном времени
- Предоставляет данные через WebSocket сервер на `ws://127.0.0.1:8181`
- **Статус**: Готов к использованию (НЕ ИЗМЕНЯТЬ)

### TradingBot (Торговый бот)
- Консольное приложение на .NET 9
- Подключается к arb1 для получения данных о спредах
- Реализует торговую стратегию Pure Market Making (PMM)
- Торгует на бирже MEXC в реальном режиме
- **Статус**: Sprint 1 завершен, в разработке

### Конфигурация MEXC
- **API Key**: `mx0vgl2GCBSEJV0C8Q`
- **API Secret**: `256739ba45c04e3da03e4ec52c6521b3`
- **Тестовый аккаунт**: $10 для разработки
- **Режим**: Только реальная торговля (Paper Trading не используется)

### Спецификация стратегии
Полная спецификация стратегии Pure Market Making находится в файле `pure_market_making_strategy_spec.md` в корне проекта.

## Общая стратегия разработки

Разработка ведется итеративно, по спринтам. Каждый спринт добавляет в продукт измеримую ценность.

- **Sprint 1: MVP - Базовый потребитель данных** ✅ ЗАВЕРШЕН
- **Sprint 2: Интеграция с MEXC API (Live Trading)** - Подключение к API биржи для реальной торговли
- **Sprint 3: Pure Market Making - Базовая реализация** - Базовая версия PMM стратегии
- **Sprint 4: PMM - Продвинутые функции** - Inventory skew, ping-pong, множественные уровни
- **Sprint 5: Управление рисками и состоянием** - Portfolio manager, risk management
- **Sprint 6: Оптимизация и продакшн** - Финальная оптимизация и мониторинг

---

## Sprint 1: MVP - Базовый потребитель данных ✅ ЗАВЕРШЕН

**Дата завершения**: 19 октября 2025

**Цель**: Создать и протестировать базовый функционал получения и обработки данных из SpreadAggregator. Результат - консольное приложение, которое подключается к WebSocket, получает и десериализует данные о спредах, и выводит торговые сигналы.

### Выполненные задачи:

1. ✅ **Настройка структуры проекта**:
   - Создано решение `TradingBot.sln`
   - Создан проект `TradingBot.ConsoleHost` (консольное приложение)
   - Создан проект `TradingBot.Core` (библиотека классов)
   - Настроена конфигурация `appsettings.json`

2. ✅ **Реализация WebSocket-клиента**:
   - Использована библиотека `Websocket.Client` для автоматического переподключения
   - Создан сервис `WebSocketConsumerService` с Reactive Extensions
   - Реализована обработка подключений/отключений
   - Исправлены nullable warnings

3. ✅ **Высокопроизводительная десериализация**:
   - Созданы DTO: `SpreadDataPackage` и `SpreadDto`
   - Использован `System.Text.Json` с **Source Generation** (`JsonContext`)
   - Реализована надежная конвертация данных с обработкой ошибок

4. ✅ **Реализация базовой торговой стратегии**:
   - Создан сервис `TradingStrategyService`
   - Порог спреда: 0.5%
   - Логика: если spreadPercentage > 0.5%, генерируется сигнал "BUY"

5. ✅ **Логирование и обработка ошибок**:
   - Интегрирован `Microsoft.Extensions.Logging`
   - Уровень логирования: Debug для отладки
   - Логируются: подключение, данные, торговые сигналы, ошибки
   - Надежная обработка ошибок десериализации

6. ✅ **Конфигурация**:
   - Добавлены MEXC API ключи в `appsettings.json`
   - Настроены параметры стратегии
   - Настроено логирование

### Критерии приемки (все выполнены):
- ✅ Приложение успешно запускается
- ✅ Приложение подключается к WebSocket-серверу arb1
- ✅ Автоматическое переподключение при разрыве соединения
- ✅ JSON-сообщения корректно десериализуются
- ✅ Торговые сигналы выводятся в консоль
- ✅ Все события логируются
- ✅ Сборка без ошибок и warnings

### Результаты тестирования:
- Успешное подключение к `ws://127.0.0.1:8181`
- Получено и обработано 889 записей о спредах
- Выявлено несколько десятков торговых сигналов с spread > 0.5%
- Примеры сигналов:
  - GAIN-USDT на Kucoin: spread 2.84%
  - AGIBUSDT на MEXC: spread 4.86%
  - SOULLAYERUSDT на MEXC: spread 11.60%

---

## Sprint 2: Интеграция с MEXC API (Live Trading) ✅ ЗАВЕРШЕН

**Дата завершения**: 19 октября 2025
**Статус**: Завершен
**Приоритет**: Высокий

**Цель**: Подключить бота к MEXC API для выставления реальных ордеров. Реализовать базовый функционал размещения и отмены ордеров.

### Выполненные задачи:

1. ✅ **Интеграция MEXC.Net библиотеки**:
   - Добавлен NuGet пакет `JK.Mexc.Net 3.10.0`
   - Изучена документация MEXC API v3
   - Настроена авторизация с API ключами

2. ✅ **Создание адаптера для MEXC**:
   - Создан интерфейс `IExchangeAdapter` с методами:
     - `PlaceOrderAsync` - размещение ордеров (limit/market)
     - `CancelOrderAsync` - отмена ордеров
     - `GetOpenOrdersAsync` - получение открытых ордеров
     - `GetOrderAsync` - получение информации об ордере
     - `GetBalancesAsync` - получение балансов
     - `GetOrderBookAsync` - получение стакана ордеров
     - `TestConnectionAsync` - проверка подключения
   - Создан `MexcExchangeAdapter` с реальными запросами к API
   - Реализована конвертация между доменными моделями и API моделями

3. ✅ **Доменные модели**:
   - Созданы модели: `Order`, `OrderResult`, `Balance`, `OrderBook`, `OrderBookEntry`
   - Созданы enums: `OrderSide`, `OrderType`, `OrderStatus`
   - Все модели оптимизированы для производительности

4. ✅ **Тестовый сервис**:
   - Создан `MexcApiTester` для комплексного тестирования
   - Тест 1: Лимитный ордер (размещение, ожидание 15 сек, отмена)
   - Тест 2: Маркет ордера (вход в позицию, ожидание 15 сек, выход с расчетом P&L)
   - Реализовано округление количества до нужной точности (2 знака для XRP)

5. ✅ **Расширенное логирование**:
   - Логирование всех API запросов
   - Логирование размещенных/отмененных ордеров
   - Логирование ошибок API с детальной информацией
   - Логирование балансов и P&L

6. ✅ **Интеграция с DI**:
   - `IExchangeAdapter` зарегистрирован в DI контейнере
   - `MexcApiTester` зарегистрирован для тестирования
   - Конфигурация читается из `appsettings.json`

### Критерии приемки (все выполнены):
- ✅ Успешная авторизация в MEXC API
- ✅ Можно получить балансы аккаунта
- ✅ Можно получить стакан ордеров для символа
- ✅ Можно выставить тестовый лимитный ордер
- ✅ Можно отменить ордер
- ✅ Можно получить список открытых ордеров
- ✅ Можно выставить маркет ордера
- ✅ Все операции логируются

### Результаты тестирования:

**Тест 1 - Лимитный ордер (XRPUSDT)**:
- ✅ Размещен лимитный BUY на 1 XRP по цене $2
- ✅ Ордер удержан 15 секунд (статус: New)
- ✅ Ордер успешно отменен

**Тест 2 - Маркет ордера (XRPUSDT)**:
- ✅ Вход: Маркет BUY 0.84 XRP по ~$2.36 = ~$1.98 USDT
- ✅ Удержание позиции 15 секунд
- ✅ Выход: Маркет SELL 0.84 XRP по ~$2.36 = ~$1.98 USDT
- ✅ P&L: ~-$0.0003 USDT (-0.02%)
- ✅ Позиция полностью закрыта

### Решенные проблемы:
- Исправлена ошибка "quantity scale is invalid" путем округления до 2 знаков
- Использованы namespace aliases для разрешения конфликтов имен
- Корректно обработаны nullable типы в API ответах

### Файлы:
- `TradingBot.Core/Abstractions/IExchangeAdapter.cs`
- `TradingBot.Core/Services/MexcExchangeAdapter.cs`
- `TradingBot.Core/Services/MexcApiTester.cs`
- `TradingBot.Core/Domain/Order*.cs`, `Balance.cs`, `OrderBook*.cs`
- `TradingBot.ConsoleHost/Program.cs` (обновлен для DI)
- `TradingBot.ConsoleHost/Worker.cs` (обновлен для тестирования)

---

## Sprint 3: Pure Market Making - Базовая реализация

**Цель**: Реализовать базовую версию стратегии Pure Market Making согласно спецификации.

### Задачи Спринта 3:

1. **Рефакторинг архитектуры стратегий**:
   - Создать интерфейс `ITradingStrategy`
   - Создать класс `Proposal` для хранения планируемых ордеров
   - Создать `PureMarketMakingStrategy` класс

2. **Реализация PMM стратегии (базовая)**:
   - Основной цикл `tick` (выполняется каждые N секунд)
   - Шаг 1: Проверки готовности
   - Шаг 2: Создание базового Proposal
     - Определение центральной цены (mid_price, last_price, best_bid, best_ask)
     - Расчет цен bid/ask ордеров на основе спреда
   - Шаг 3: Применение бюджетных ограничений
   - Шаг 4: Управление активными ордерами
     - Отмена устаревших ордеров
   - Шаг 5: Размещение новых ордеров

3. **Конфигурация PMM**:
   - Добавить параметры в `appsettings.json`:
     ```json
     "PureMarketMaking": {
       "Exchange": "mexc",
       "Market": "BTC-USDT",
       "BidSpread": 0.15,
       "AskSpread": 0.15,
       "OrderAmount": 0.001,
       "OrderRefreshTime": 10.0,
       "OrderRefreshTolerancePct": 0.2,
       "PriceType": "mid_price"
     }
     ```

4. **Сервис рыночных данных**:
   - Создать `IMarketDataService`:
     - Получение mid price
     - Получение best bid/ask
     - Получение order book
   - Использовать данные из arb1 + запросы к MEXC

5. **Тестирование**:
   - Ручное тестирование на паре с низкой волатильностью
   - Проверка корректности расчета цен
   - Проверка размещения симметричных ордеров

### Критерии приемки:
- [ ] Стратегия выставляет симметричные bid/ask ордера
- [ ] Ордера размещаются с правильным спредом
- [ ] Ордера обновляются согласно `order_refresh_time`
- [ ] Старые ордера корректно отменяются
- [ ] Все действия стратегии логируются

---

## Sprint 4: PMM - Продвинутые функции

**Цель**: Добавить продвинутые функции PMM стратегии из спецификации.

### Задачи Спринта 4:

1. **Inventory Skew механизм**:
   - Расчет общей стоимости портфеля
   - Расчет текущего процента базового актива
   - Расчет отклонения от целевого баланса
   - Асимметричное изменение объемов ордеров
   - Параметры: `inventory_skew_enabled`, `inventory_target_base_pct`, `inventory_range_multiplier`

2. **Ping-Pong режим**:
   - Отслеживание последней исполненной стороны
   - Логика выставления только противоположных ордеров
   - Параметр: `ping_pong_enabled`
   - Обработка `OrderFilledEvent`

3. **Множественные уровни ордеров**:
   - Параметры: `order_levels`, `order_level_spread`
   - Размещение нескольких ордеров с каждой стороны
   - Каскадное распределение объема

4. **Дополнительные функции**:
   - `filled_order_delay` - задержка после исполнения ордера
   - `hanging_orders_enabled` - сохранение частично исполненных ордеров
   - `price_ceiling` / `price_floor` - ценовые ограничения
   - `order_optimization_enabled` - улучшение цен ордеров
   - `max_order_age` - максимальный возраст ордера

5. **Обработка событий биржи**:
   - Подписка на обновления ордеров
   - `OrderFilledEvent` - частичное/полное исполнение
   - `OrderCompletedEvent` - ордер полностью исполнен
   - `OrderCancelledEvent` - ордер отменен

### Критерии приемки:
- [ ] Inventory skew корректно балансирует портфель
- [ ] Ping-pong режим работает как ожидается
- [ ] Множественные уровни ордеров выставляются правильно
- [ ] Hanging orders не отменяются при обновлении
- [ ] Price ceiling/floor работают корректно
- [ ] Все функции из спецификации реализованы

---

## Sprint 5: Управление рисками и состоянием

**Цель**: Добавить систему управления рисками и сохранение состояния.

### Задачи Спринта 5:

1. **Portfolio Manager**:
   - Создать `IPortfolioManager` интерфейс
   - Отслеживание балансов всех активов
   - Отслеживание открытых позиций
   - Расчет PnL (Profit and Loss)
   - Расчет общей стоимости портфеля

2. **Risk Management**:
   - Проверка достаточности средств перед ордером
   - Максимальный размер позиции на актив
   - Максимальная экспозиция портфеля
   - Защита от "fat finger" ошибок

3. **State Management**:
   - Сохранение состояния в JSON файл:
     - Активные ордера
     - История сделок
     - Текущие балансы
     - Конфигурация стратегии
   - Восстановление состояния при перезапуске
   - Синхронизация с биржей при старте

4. **Мониторинг**:
   - Базовые метрики в консоль:
     - Текущий PnL
     - Количество активных ордеров
     - Количество сделок за сессию
     - Винрейт
   - Периодический вывод статистики

### Критерии приемки:
- [ ] Бот не может выставить ордер при недостатке средств
- [ ] Состояние сохраняется при остановке
- [ ] Состояние восстанавливается при запуске
- [ ] PnL рассчитывается корректно
- [ ] Базовый мониторинг работает

---

## Sprint 6: Оптимизация и продакшн

**Цель**: Оптимизировать производительность и подготовить к продакшн использованию.

### Задачи Спринта 6:

1. **Оптимизация производительности**:
   - Профилирование приложения
   - Устранение аллокаций памяти
   - Использование `Span<T>`, `Memory<T>` где возможно
   - Оптимизация десериализации
   - Пулинг объектов

2. **Метрики и мониторинг**:
   - Интеграция Prometheus/Grafana (опционально)
   - Метрики:
     - WebSocket: сообщений/сек, задержка
     - Стратегия: сигналов/сек
     - Ордера: размещено, отменено, исполнено
     - PnL, винрейт, drawdown
     - Latency торговых операций

3. **Структурированное логирование**:
   - Настройка Serilog
   - JSON логи в файл
   - Ротация логов
   - Разные уровни для продакшена

4. **Тестирование и документация**:
   - Unit тесты для критических компонентов
   - Документация по запуску
   - Руководство по конфигурации
   - Troubleshooting guide

5. **Продакшн готовность**:
   - Graceful shutdown
   - Health checks
   - Обработка критических ошибок
   - Алерты при проблемах

### Критерии приемки:
- [ ] Производительность оптимизирована
- [ ] Метрики собираются
- [ ] Логи структурированы
- [ ] Документация готова
- [ ] Бот готов к длительной работе

---

## Текущий статус проекта

**Завершено**:
- ✅ Sprint 1: MVP - Базовый потребитель данных (19 октября 2025)
- ✅ Sprint 2: Интеграция с MEXC API (Live Trading) (19 октября 2025)

**Следующий шаг**:
- 🔄 Sprint 3: Pure Market Making - Базовая реализация

**Файлы проекта**:
- `TradingBot/src/TradingBot.Core/` - Основная логика
- `TradingBot/src/TradingBot.ConsoleHost/` - Хост приложение
- `TradingBot/src/TradingBot.ConsoleHost/appsettings.json` - Конфигурация

**Зависимости**:
- arb1 должен быть запущен на `ws://127.0.0.1:8181`
- MEXC API ключи настроены в конфигурации

---

## Примечания

### Принципы разработки
- **KISS**: Простота превыше всего
- **YAGNI**: Не реализуем то, что не нужно сейчас
- **Zero-Copy**: Минимизация аллокаций памяти
- **High Performance**: Производительность критична

### Безопасность
- API ключи хранятся в конфигурации (для разработки)
- Для продакшна использовать User Secrets или переменные окружения
- Не коммитить ключи в Git

### Риски
- Волатильность рынка может привести к убыткам
- API rate limits MEXC
- Технические сбои биржи
- Недостаточная ликвидность на некоторых парах

### Рекомендации
- Начинать торговлю с минимальных объемов
- Тщательно тестировать каждую функцию
- Мониторить работу бота 24/7
- Регулярно проверять балансы и PnL
